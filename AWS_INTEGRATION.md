# AWS Cognito Integration - Implementation Summary

This document summarizes the changes made to integrate AWS Cognito authentication with the Sphere of Influence game.

## üîÑ Changes Made

### 1. AWS Infrastructure (Terraform)

Created complete Terraform configuration in `/terraform/`:

- **Cognito User Pool** (`cognito.tf`)
  - User registration and authentication
  - Email verification
  - Password policies
  - OAuth configuration

- **API Gateway** (`api_gateway.tf`)
  - REST API with Cognito authorizer
  - WebSocket API for real-time communication
  - CORS configuration
  - JWT token validation

- **ECS (Optional)** (`ecs.tf`)
  - Containerized deployment option
  - ECR repository for Docker images
  - CloudWatch logging

- **IAM Roles** (in various files)
  - Least privilege access
  - Service-to-service authentication

### 2. Backend Changes

Updated Go backend to support AWS Cognito:

- **Authentication Middleware** (`internal/auth/cognito.go`)
  - JWT token validation
  - JWKS key management
  - User context management

- **Updated Server** (`internal/server/server.go`)
  - WebSocket authentication via query parameters
  - User profile endpoints
  - Cognito user ID integration

- **Updated Dependencies** (`go.mod`)
  - AWS SDK v2
  - JWT library

### 3. Frontend Changes

Enhanced React frontend with authentication:

- **AWS Configuration** (`src/aws-config.js`)
  - Environment-based configuration
  - Development fallbacks

- **Authentication Context** (`src/contexts/AuthContext.jsx`)
  - AWS Amplify integration
  - User state management
  - Token management

- **Login Component** (`src/components/LoginForm.jsx`)
  - Sign up/sign in interface
  - Email verification flow
  - Error handling

- **Updated App Component** (`src/ui/App.tsx`)
  - Authentication integration
  - User status display
  - Authenticated WebSocket connections

### 4. Deployment Infrastructure

- **Automated Deployment** (`deploy-aws.sh`)
  - Infrastructure deployment
  - Configuration generation
  - Application building

- **Environment Configuration** (`frontend/.env.example`)
  - AWS service URLs
  - Cognito configuration

## üîß Key Features Implemented

### Authentication Flow

1. **User Registration**
   - Email-based signup
   - Email verification required
   - Password complexity requirements

2. **User Login**
   - Username/email + password
   - JWT token generation
   - Automatic token refresh

3. **WebSocket Authentication**
   - Token passed as query parameter
   - Server-side token validation
   - User context in game session

### Security Measures

- **JWT Token Validation**
  - RSA signature verification
  - Token expiration checks
  - Issuer validation

- **API Authorization**
  - Protected endpoints
  - User-specific data access
  - CORS configuration

- **WebSocket Security**
  - Connection-level authentication
  - User identity validation

## üöÄ Deployment Steps

### 1. Prerequisites
```bash
# Install required tools
brew install terraform awscli
aws configure  # Set up AWS credentials
```

### 2. Deploy Infrastructure
```bash
cd terraform
cp terraform.tfvars.example terraform.tfvars
# Edit terraform.tfvars with your values
terraform init
terraform apply
```

### 3. Configure Applications
```bash
# Frontend configuration (auto-generated by deploy script)
cd frontend
cp .env.example .env.local
# Values populated from Terraform outputs

# Backend environment variables
export AWS_REGION=us-east-1
export COGNITO_USER_POOL_ID=<from-terraform>
export COGNITO_CLIENT_ID=<from-terraform>
```

### 4. Run Applications
```bash
# Quick deployment (everything automated)
./deploy-aws.sh

# Or manual development
cd frontend && npm run dev
cd backend && go run cmd/server/main.go
```

## üìù Configuration Variables

### Terraform Variables (`terraform.tfvars`)
```hcl
aws_region = "us-east-1"
project_name = "sphere-of-influence"
environment = "dev"
cognito_callback_urls = ["http://localhost:5173"]
cognito_logout_urls = ["http://localhost:5173"]
enable_ecs = false  # Set to true for ECS deployment
```

### Frontend Environment (`.env.local`)
```env
VITE_AWS_REGION=us-east-1
VITE_COGNITO_USER_POOL_ID=us-east-1_XXXXXXXXX
VITE_COGNITO_CLIENT_ID=xxxxxxxxxxxxxxxxxxxxxxxxxx
VITE_COGNITO_IDENTITY_POOL_ID=us-east-1:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
VITE_API_GATEWAY_URL=https://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/dev
VITE_WEBSOCKET_URL=wss://xxxxxxxxxx.execute-api.us-east-1.amazonaws.com/dev
VITE_COGNITO_DOMAIN=https://sphere-of-influence-dev-xxxxxxxx.auth.us-east-1.amazoncognito.com
```

## üîç Testing the Integration

### 1. User Registration Flow
1. Visit the application
2. Click "Sign In / Sign Up"
3. Switch to "Sign Up" tab
4. Enter username, email, display name, password
5. Check email for verification code
6. Enter verification code
7. Automatically signed in

### 2. WebSocket Authentication
1. After authentication, enter commander name
2. Click "Launch Mission"
3. WebSocket connection includes JWT token
4. Server validates token and creates authenticated player
5. Game proceeds with user identity

### 3. API Endpoints
- `GET /api/profile` - Returns authenticated user info
- `GET /api/rooms` - Lists available game rooms
- `POST /api/rooms` - Creates new room (authenticated)

## üö® Important Notes

### Development vs Production

- **Development**: Uses localhost URLs, self-signed certificates
- **Production**: Update Cognito callback URLs to production domain

### Cost Considerations

- **Cognito**: Free tier covers most development usage
- **API Gateway**: Pay per request model
- **ECS**: Optional, only if container deployment desired

### Security Best Practices

- Never commit `.env.local` or `terraform.tfvars` to version control
- Use different Cognito User Pools for different environments
- Regularly rotate JWT signing keys
- Monitor CloudWatch logs for suspicious activity

## üîÑ Migration Path

For existing users of the non-authenticated version:

1. **Deploy side-by-side**: Run both versions during transition
2. **Import existing users**: Create accounts for existing players
3. **Gradual migration**: Allow both authenticated and legacy connections
4. **Sunset legacy**: Remove non-authenticated access after migration

## üêõ Troubleshooting

### Common Issues

1. **CORS Errors**: Verify API Gateway CORS configuration
2. **Token Expired**: Implement automatic token refresh
3. **WebSocket Fails**: Check token format in query parameter
4. **Email Not Received**: Check spam folder, verify SES configuration

### Debug Tools

- AWS CloudWatch for backend logs
- Browser DevTools for frontend issues
- AWS CLI for testing Cognito directly
- Terraform state for infrastructure issues

## üìä Monitoring and Metrics

The infrastructure includes monitoring for:
- User registration/login rates
- API request success/failure rates
- WebSocket connection metrics
- Game session durations
- Error rates by endpoint

Access through AWS CloudWatch console or included Prometheus setup.

---

This completes the AWS Cognito integration for the Sphere of Influence game. The implementation provides enterprise-grade authentication while maintaining the real-time multiplayer gaming experience.
